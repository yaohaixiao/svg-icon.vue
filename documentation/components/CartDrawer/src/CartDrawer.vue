<template>
  <base-drawer
    ref="drawer"
    :title="title"
    header-border
    size="medium"
    :buttons="buttons"
    custom-class="card-drawer"
    @close="onClose">
    <template v-slot:tabs>
      <base-tab-nav
        v-model="active"
        stretch
        :tabs="tabs"
        class="cart-drawer__tabs" />
    </template>
    <template
      v-if="isIconView"
      v-slot:toolbar>
      <base-header
        role="toolbar"
        flex
        height="inner"
        padding="inner"
        :border="true"
        class="cart-drawer__toolbar">
        <template v-slot:start>
          <base-checkbox
            v-model="checked"
            :indeterminate="isIndeterminate"
            :disabled="disabled"
            @change="onCheckAll">
            全选（{{ count }}）
          </base-checkbox>
        </template>
      </base-header>
    </template>
    <div :class="['cart-drawer__main', { 'is-auto': isIconView && !disabled }]">
      <ul
        v-if="isIconView"
        :class="['cart-drawer__list', { 'is-empty': disabled }]">
        <template v-if="items.length > 0">
          <cart-drawer-item
            v-for="(item, i) in collections"
            :key="`item-${i}`"
            :symbol="item.symbol"
            :is-checked="item.checked"
            :index="i"
            @check="onCheckItem"
            @delete="onDeleteItem" />
        </template>
        <cart-drawer-item
          v-else
          is-empty>
          <base-empty />
        </cart-drawer-item>
      </ul>
      <textarea
        v-else
        readonly
        :value="code"
        class="cart-drawer__code" />
    </div>
  </base-drawer>
</template>

<script>
/**
 * CartDrawer.vue - CartDrawer 组件
 * =============================================================
 * Created By: Yaohaixiao
 * Update: 2022.11.10
 */
import BaseDrawer from '$components/BaseDrawer'
import BaseHeader from '$components/BaseHeader'
import BaseTabNav from '$components/BaseTabNav'
import BaseCheckbox from '$components/BaseCheckbox'
import BaseEmpty from '$components/BaseEmpty'

import CartDrawerItem from '$components/CartDrawerItem'

import { clearStorage } from '$utils/storage'
import { copyToClipboard, createAndDownloadFile } from '$utils/utils'

export default {
  name: 'CartDrawer',
  componentName: 'CartDrawer',
  components: {
    BaseDrawer,
    BaseHeader,
    BaseTabNav,
    BaseCheckbox,
    BaseEmpty,
    CartDrawerItem
  },
  props: {
    title: {
      type: String,
      default: '购物车'
    },
    items: {
      type: Array,
      default: () => []
    }
  },
  data() {
    return {
      active: 'icon',
      checked: false,
      tabs: [
        {
          label: 'SVG 图标集',
          value: 'icon'
        },
        {
          label: 'JS 源代码',
          value: 'code'
        }
      ],
      collections: [],
      buttons: []
    }
  },
  computed: {
    isIconView() {
      return this.active === 'icon'
    },
    isIndeterminate() {
      const selected = this.selected

      return selected.length > 0 && selected.length < this.collections.length
    },
    disabled() {
      return this.collections.length === 0
    },
    selected() {
      return this.collections.filter((item) => item.checked)
    },
    symbols() {
      return this.selected.map((item) => item.symbol)
    },
    count() {
      return this.selected.length
    },
    code() {
      const iconSet = {
        title: 'SvgIcon 图标集',
        code: 'SvgIconSet',
        symbols: this.symbols
      }
      const json = JSON.stringify(iconSet, null, 2)

      return `// Generated by svg-icon.vue\nconst SvgIconSet = ${json}\n\nexport default SvgIconSet\n`
    },
    svg() {
      return (
        '<!-- Generated by svg-icon.vue -->\n' +
        '<svg id="svg-icons" aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden;">\n' +
        this.symbols.join('\n') +
        '\n</svg>'
      )
    }
  },
  watch: {
    items() {
      this.update()
    },
    count() {
      this.updateButtons()
      this.updateCheckAll()
    }
  },
  created() {
    this.update()
  },
  mounted() {
    this.$subscribe('show:drawer', this.show)
    this.$subscribe('hide:drawer', this.hide)
  },
  beforeDestroy() {
    this.$unsubscribe('show:drawer', this.show)
    this.$unsubscribe('hide:drawer', this.hide)
    this.$broadcast('show:cert')
  },
  methods: {
    update() {
      this.collections = this.items.map((item) => {
        return {
          checked: true,
          symbol: item
        }
      })

      this.updateCheckAll()
      this.updateButtons()
    },
    updateCheckAll() {
      this.checked = this.count > 0
    },
    updateButtons() {
      this.buttons = [
        {
          name: 'cancel',
          text: '取消',
          size: 'small'
        },
        {
          name: 'clean',
          text: '清空',
          icon: 'trash',
          disabled: this.disabled,
          action: () => {
            clearStorage('svg.icon.set')

            this.$message.success({
              round: true,
              message: `购物车已清空！`
            })

            this.$broadcast('clean:cart')
          }
        },
        {
          name: 'download',
          text: '下载',
          icon: 'download',
          disabled: this.count === 0,
          action: () => {
            if (this.isIconView) {
              createAndDownloadFile('svg-icon-set.svg', this.svg)
            } else {
              createAndDownloadFile('svg-icon-set.js', this.code)
            }
          }
        },
        {
          name: 'confirm',
          text: '复制',
          icon: 'copy',
          size: 'small',
          type: 'primary',
          disabled: this.count === 0,
          action: () => {
            copyToClipboard(this.isIconView ? this.svg : this.code)
            this.$message.success({
              round: true,
              message: `代码已复制！`
            })
          }
        }
      ]
    },
    uncheckAll() {
      this.collections = this.items.map((item) => {
        return {
          checked: false,
          symbol: item
        }
      })
    },
    checkAll() {
      this.collections = this.items.map((item) => {
        return {
          checked: true,
          symbol: item
        }
      })
    },
    show() {
      this.$refs.drawer.open()
    },
    hide() {
      this.$refs.drawer.close()
    },
    close() {
      setTimeout(() => {
        this.$broadcast('show:cart')
      }, 300)
    },
    onCheckAll(checked) {
      const isIndeterminate = this.isIndeterminate

      if (isIndeterminate || (checked && !isIndeterminate)) {
        this.checkAll()
      } else {
        this.uncheckAll()
      }
    },
    onCheckItem({ id, checked }) {
      const collections = [...this.collections]

      collections[id].checked = checked
      this.collections = collections
    },
    onDeleteItem({ symbol, name }) {
      this.$broadcast('remove:icon', symbol)

      this.$message.success({
        round: true,
        message: `图标 ${name} 已移除购物车！`
      })
    },
    onClose() {
      this.close()
    }
  }
}
</script>

<style scoped lang="less">
@import './cart-drawer';
</style>
