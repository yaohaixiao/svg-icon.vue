<template>
  <base-drawer
    ref="drawer"
    :title="title"
    header-border
    size="medium"
    :buttons="buttons"
    custom-class="card-drawer"
    @close="onClose">
    <template v-slot:tabs>
      <base-tab-nav
        v-model="active"
        stretch
        :tabs="tabs"
        class="cart-drawer__tabs" />
    </template>
    <template
      v-if="isIconView"
      v-slot:toolbar>
      <cart-drawer-toolbar
        :is-checked="checked"
        :items="options"
        :selected="selected"
        @check="onCheckAll"
        @import="onImport" />
    </template>
    <div :class="['cart-drawer__main', { 'is-auto': isIconView && !disabled }]">
      <ul
        v-if="isIconView"
        :class="['cart-drawer__list', { 'is-empty': disabled }]">
        <template v-if="options.length > 0">
          <cart-drawer-item
            v-for="(item, i) in options"
            :key="`item-${i}`"
            :symbol="item.symbol"
            :is-checked="item.checked"
            :is-build-in="item.isBuildIn"
            :index="i"
            @check="onCheckItem"
            @delete="onDeleteItem" />
        </template>
        <cart-drawer-item
          v-else
          is-empty>
          <base-empty />
        </cart-drawer-item>
      </ul>
      <textarea
        v-else
        readonly
        :value="code"
        class="cart-drawer__code" />
    </div>
  </base-drawer>
</template>

<script>
/**
 * CartDrawer.vue - CartDrawer 组件
 * =============================================================
 * Created By: Yaohaixiao
 * Update: 2022.11.10
 */
import BaseDrawer from '$components/BaseDrawer'
import BaseTabNav from '$components/BaseTabNav'
import BaseEmpty from '$components/BaseEmpty'

import CartDrawerToolbar from '$components/CartDrawerToolbar'
import CartDrawerItem from '$components/CartDrawerItem'

import { clearStorage } from '$utils/storage'
import { copyToClipboard, createAndDownloadFile } from '$utils/utils'
import { render, getSymbols } from '@/utils/utils'

let guid = 0

export default {
  name: 'CartDrawer',
  componentName: 'CartDrawer',
  components: {
    BaseDrawer,
    BaseTabNav,
    BaseEmpty,
    CartDrawerToolbar,
    CartDrawerItem
  },
  props: {
    title: {
      type: String,
      default: '购物车'
    },
    items: {
      type: Array,
      default: () => []
    }
  },
  data() {
    return {
      active: 'icon',
      checked: false,
      tabs: [
        {
          label: 'SVG 图标集',
          value: 'icon'
        },
        {
          label: 'JS 源代码',
          value: 'code'
        }
      ],
      collections: [],
      imports: [],
      options: [],
      buttons: []
    }
  },
  computed: {
    isIconView() {
      return this.active === 'icon'
    },
    isUnchecked() {
      return this.count === 0
    },
    disabled() {
      return this.options.length === 0
    },
    selected() {
      return this.options.filter((item) => item.checked)
    },
    symbols() {
      return this.selected.map((item) => item.symbol)
    },
    count() {
      return this.selected.length
    },
    code() {
      const iconSet = {
        title: 'SvgIcon 图标集',
        code: 'SvgIconSet',
        symbols: this.symbols
      }
      const json = JSON.stringify(iconSet, null, 2)

      return `// Generated by svg-icon.vue\nconst SvgIconSet = ${json}\n\nexport default SvgIconSet\n`
    },
    svg() {
      return (
        '<!-- Generated by svg-icon.vue -->\n' +
        '<svg id="svg-icons" aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden;">\n' +
        this.symbols.join('\n') +
        '\n</svg>'
      )
    }
  },
  watch: {
    items() {
      this.update()
    },
    count() {
      this.updateButtons()
      this.updateCheckAll()
    }
  },
  created() {
    this.update()
  },
  mounted() {
    this.$subscribe('show:drawer', this.show)
    this.$subscribe('hide:drawer', this.hide)
  },
  beforeDestroy() {
    this.$unsubscribe('show:drawer', this.show)
    this.$unsubscribe('hide:drawer', this.hide)
    this.$broadcast('show:cert')
  },
  methods: {
    update() {
      this.collections = this.items.map((symbol) => {
        return {
          checked: true,
          isBuiltIn: true,
          symbol
        }
      })

      this.options = this.collections.concat(this.imports)

      this.updateCheckAll()
      this.updateButtons()
    },
    updateCheckAll() {
      this.checked = this.count > 0
    },
    updateButtons() {
      this.buttons = [
        {
          name: 'cancel',
          text: '取消',
          size: 'small'
        },
        {
          name: 'clean',
          text: '清空',
          icon: 'trash',
          disabled: this.disabled,
          action: () => {
            clearStorage('svg.icon.set')
            this.imports = []

            this.$message.success({
              round: true,
              message: `购物车已清空！`
            })

            this.$broadcast('clean:cart')
          }
        },
        {
          name: 'download',
          text: '下载',
          icon: 'download',
          disabled: this.isUnchecked,
          action: () => {
            if (this.isIconView) {
              createAndDownloadFile('svg-icon-set.svg', this.svg)
            } else {
              createAndDownloadFile('svg-icon-set.js', this.code)
            }
          }
        },
        {
          name: 'confirm',
          text: '复制',
          icon: 'copy',
          size: 'small',
          type: 'primary',
          disabled: this.isUnchecked,
          action: () => {
            copyToClipboard(this.isIconView ? this.svg : this.code)
            this.$message.success({
              round: true,
              message: `代码已复制！`
            })
          }
        }
      ]
    },
    uncheckAll() {
      const options = this.collections.concat(this.imports)

      this.options = options.map((item) => {
        const { isBuildIn, symbol } = item

        return {
          checked: false,
          isBuildIn,
          symbol
        }
      })
    },
    checkAll() {
      const options = this.collections.concat(this.imports)

      this.options = options.map((item) => {
        const { isBuildIn, symbol } = item

        return {
          checked: true,
          isBuildIn,
          symbol
        }
      })
    },
    doCheck(id, checked) {
      const collections = [...this.options]

      collections[id].checked = checked
      this.options = collections
    },
    doImport(symbol, id) {
      const symbols = getSymbols()
      const theSameSymbol = symbols.find((item) => {
        const PATTERN_ID = /id="(.*?)"/
        const match = item.match(PATTERN_ID)
        const name = match && match[1] ? match[1] : ''

        return name.toLowerCase() === id.toLowerCase()
      })

      if (theSameSymbol) {
        guid += 1
        symbol = symbol.replace(id, `${id}-${guid}`)
        render({
          symbols: [symbol]
        })
      }

      this.imports.push({
        checked: true,
        isBuildIn: false,
        symbol
      })

      this.update()
    },
    doDelete(symbol, name, isBuildIn) {
      let imports
      let $symbol

      if (!isBuildIn) {
        imports = [...this.imports]
        $symbol = document.querySelector(`#icon-${name}`)

        this.imports = imports.filter((item) => {
          return item.symbol !== symbol
        })

        if ($symbol) {
          $symbol.parentNode.removeChild($symbol)
        }

        this.update()
      } else {
        this.$broadcast('remove:icon', symbol)
      }

      this.$message.success({
        round: true,
        message: `图标 ${name} 已移除购物车！`
      })
    },
    show() {
      this.$refs.drawer.open()
    },
    hide() {
      this.$refs.drawer.close()
    },
    close() {
      setTimeout(() => {
        this.$broadcast('show:cart')
      }, 300)
    },
    onCheckAll(checked, isIndeterminate) {
      if (isIndeterminate || (checked && !isIndeterminate)) {
        this.checkAll()
      } else {
        this.uncheckAll()
      }
    },
    onImport(symbol, id) {
      this.doImport(symbol, id)
    },
    onCheckItem({ id, checked }) {
      this.doCheck(id, checked)
    },
    onDeleteItem({ symbol, name, isBuildIn }) {
      this.doDelete(symbol, name, isBuildIn)
    },
    onClose() {
      this.close()
    }
  }
}
</script>

<style scoped lang="less">
@import './cart-drawer';
</style>
